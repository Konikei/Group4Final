{% extends 'shoppingpage/main.html' %}
{% load static %}

{% block content %}
<div class="row">
  {% for product in products %}
  <div class="col-lg-4">
    <img class="thumbnail" src="{% static 'images/placeholder.png' %}">
    <div class="box-element product">
      <h6><strong>{{ product.name }}</strong></h6>
      <hr>
      <button data-product="{{ product.id }}" data-action="add" class="btn btn-outline-secondary add-to-cart">Add to cart</button>
      <a class="btn btn-outline-success" href="#">View</a>
      <h4 style="display: inline-block; float: right"><strong>${{ product.price|floatformat:1 }}</strong></h4>
    </div>
  </div>
  {% endfor %}
</div>

<div>
  <hr>
  <h3>Cart</h3>
  {% if cart_items %}
  <table class="table">
    <thead>
      <tr>
        <th>Product</th>
        <th>Price</th>
        <th>Quantity</th>
        <th>Points</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody>
      {% for item in cart_items %}
      <tr>
        <td>{{ item.product.name }}</td>
        <td>${{ item.product.price }}</td>
        <td>{{ item.quantity }}</td>
        <td>{{ item.product.points }}</td>
        <td>${{ item.total }}</td>
      </tr>
      {% endfor %}
      <tr>
        <td></td>
        <td></td>
        <td></td>
        <td><strong>Total Points:</strong></td>
        <td><strong>{{ total_points }}</strong></td>
      </tr>
      <tr>
        <td></td>
        <td></td>
        <td></td>
        <td><strong>Total Price:</strong></td>
        <td><strong>${{ total_price }}</strong></td>
      </tr>
    </tbody>
  </table>

  <div class="row">
    <div class="col-md-6">
      <a href="{% url 'shoppingpage:checkout' %}" class="btn btn-primary">Checkout</a>
    </div>
    <div class="col-md-6">
      {% if total_points >= required_points %}
      <button data-action="purchase" class="btn btn-success purchase-with-points">Purchase with Points</button>
      {% endif %}
    </div>
  </div>
  {% else %}
  <p>Your cart is empty.</p>
  {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  var addToCartButtons = document.getElementsByClassName("add-to-cart");
  for (var i = 0; i < addToCartButtons.length; i++) {
    addToCartButtons[i].addEventListener("click", function() {
      var productId = this.getAttribute("data-product");
      var action = this.getAttribute("data-action");
      updateCart(productId, action);
    });
  }

  var purchaseWithPointsButton = document.getElementsByClassName("purchase-with-points")[0];
  if (purchaseWithPointsButton) {
    purchaseWithPointsButton.addEventListener("click", function() {
      var action = this.getAttribute("data-action");
      purchaseWithPoints(action);
    });
  }

  function updateCart(productId, action) {
    var url = "/update-cart/";
    var data = {
      productId: productId,
      action: action
    }

    fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken
      },
      body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => location.reload())
  }

  function purchaseWithPoints(action) {
    var url = "/purchase-with-points/";
    var data = {
      action: action
    }

    fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken
      },
      body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
      if (data["status"] === "success") {
        alert("Purchase successful!");
        location.href = "{% url 'shoppingpage:index' %}";
      } else {
        alert("Purchase failed: " + data["message"]);
      }
    });
  }
});
</script>